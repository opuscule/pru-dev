<section id="happy-families" class="pt-24 bg-[var(--color-bg-extralight)]" style="padding-bottom:200px;margin-bottom:-200px">
  <div class="max-w-[var(--width-container-content)] mx-auto px-4">
    <h1 class="font-titles text-center text-5xl md:text-7xl font-bold mb-12">Happy Families</h1>
    
    <!-- Masonry Grid Container -->
    <div id="happy-families-grid" class="masonry-grid"></div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    (async () => {
      const SPACE_ID = '{{ settings.contentful_space_id | escape }}';
      const ACCESS_TOKEN = '{{ settings.contentful_access_token | escape }}';
      const CONTENT_TYPE = 'happy_families';

      if (!SPACE_ID || !ACCESS_TOKEN) {
        console.warn('Happy Families: Contentful credentials not configured');
        return;
      }

      const endpoint = `https://cdn.contentful.com/spaces/${SPACE_ID}/environments/master/entries?access_token=${ACCESS_TOKEN}&content_type=${CONTENT_TYPE}&include=2`;
      try {
        const res = await fetch(endpoint);
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        const grid = document.getElementById('happy-families-grid');
        
        if (!data.items || data.items.length === 0) {
          grid.innerHTML = '<p class="text-center col-span-2">No testimonials found.</p>';
          return;
        }

        const assetMap = new Map();
        if (data.includes && data.includes.Asset) {
          for (const a of data.includes.Asset) assetMap.set(a.sys.id, a.fields);
        }

        // Show all testimonials
        const testimonials = data.items
          .map((v) => ({ v, r: Math.random() }))
          .sort((a, b) => a.r - b.r)
          .map(({ v }) => v);

        const cards = [];
        const schemas = [];
        
        testimonials.forEach((item, i) => {
          const f = item.fields;
          let imageUrl = '';
          if (f.image && f.image.sys && f.image.sys.id) {
            const asset = assetMap.get(f.image.sys.id);
            if (asset && asset.file && asset.file.url) {
              imageUrl = asset.file.url.startsWith('//') ? 'https:' + asset.file.url : asset.file.url;
            }
          }
          
          const stars = '<span class="text-[var(--color-primary)]">â˜…</span>'.repeat(5);
          
          // Generate card HTML with masonry-friendly structure
          cards.push(`
            <div class="testimonial-card bg-[#E8E4D9] rounded-[32px] p-8 break-inside-avoid mb-8">
              <div class="flex items-start gap-6 mb-4">
                <div class="relative shrink-0">
                  <div class="absolute -left-2 -bottom-2 w-[120px] h-[120px] rounded-[24px] bg-[#F2635B]"></div>
                  ${
                    imageUrl
                      ? `<img src="${imageUrl}?w=300&h=300" alt="${
                          f.puppysName || ''
                        }" width="300" height="300" class="relative rounded-[24px] w-[120px] h-[120px] object-cover" loading="lazy">`
                      : '<div class="relative rounded-[24px] w-[120px] h-[120px] bg-gray-300"></div>'
                  }
                </div>
                <div class="flex-1 pt-2">
                  <div class="mb-2 leading-none text-lg">${stars}</div>
                  <h3 class="font-titles text-3xl tracking-wide mb-4 leading-tight">${f.title || ''}</h3>
                </div>
              </div>
              
              <p class="leading-relaxed text- text-gray-800">${f.quote || ''}</p>
            </div>`);
          
          // Format date for schema (YYYY-MM-DD format)
          let formattedDate = '';
          if (f.dateSubmitted) {
            const date = new Date(f.dateSubmitted);
            if (!isNaN(date.getTime())) {
              formattedDate = date.toISOString().split('T')[0];
            }
          }
          
          // Generate schema.org Review markup
          const schema = {
            "@context": "https://schema.org/",
            "@type": "Review",
            "itemReviewed": {
              "@type": "Organization",
              "name": "Puppys R Us, LLC.",
              "url": "https://puppysrus.com/",
              "address": {
                "@type": "PostalAddress",
                "streetAddress": "1404 Southern Hills #246",
                "addressLocality": "West Plains",
                "addressRegion": "MO",
                "postalCode": "65775",
                "addressCountry": "US"
              },
              "contactPoint": {
                "@type": "ContactPoint",
                "telephone": "+1-844-733-7877",
                "contactType": "Sales",
                "email": "sales@puppysrus.com"
              }
            },
            "author": {
              "@type": "Person",
              "name": f.ownersName || "Anonymous"
            },
            "reviewRating": {
              "@type": "Rating",
              "ratingValue": "5",
              "bestRating": "5",
              "worstRating": "1"
            },
            "reviewBody": f.quote || ""
          };
          
          // Only add datePublished if we have a valid date
          if (formattedDate) {
            schema.datePublished = formattedDate;
          }
          
          schemas.push(`<script type="application/ld+json">${JSON.stringify(schema)}<\/script>`);
        });

        grid.innerHTML = cards.join('');
        
        // Append all schema markup to the page head
        const schemaContainer = document.createElement('div');
        schemaContainer.innerHTML = schemas.join('');
        document.head.appendChild(schemaContainer);

      } catch (e) {
        console.error('Happy Families testimonials load error', e);
        const grid = document.getElementById('happy-families-grid');
        if (grid) {
          grid.innerHTML =
            '<p class="text-center text-red-600 col-span-2">Error loading testimonials. Please try again later.</p>';
        }
      }
    })();
  });
</script>

{% stylesheet %}
  .masonry-grid {
    column-count: 1;
    column-gap: 2rem;
  }

  @media (min-width: 768px) {
    .masonry-grid {
      column-count: 2;
    }
  }

  .testimonial-card {
    display: inline-block;
    width: 100%;
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Happy Families",
  "settings": [],
  "presets": [
    {
      "name": "Happy Families"
    }
  ]
}
{% endschema %}
