{% comment %}
  This section is used in the cart template to render /cart page with an
  overview of the items in customer's cart.

  https://shopify.dev/docs/storefronts/themes/architecture/templates/cart
{% endcomment %}

<style>
  .cart-item-pod {
    background-color: var(--color-bg-card);
    border-radius: 30px;
  }

  .order-summary-box {
    background-color: var(--color-bg-card);
    border-radius: 30px;
  }

  .order-summary-box ul li {
    border-bottom: 1px solid #b1b1b1;
  }

  .checkout-agreement {
    background-color: var(--color-white);
    border-radius: 20px;
  }

  .form-check-input:checked {
    background-color: var(--color-black);
    border-color: var(--color-black);
  }

  .checkout-btn {
    border-radius: 10rem;
    font-size: 1.125rem;
    font-weight: 500;
    transition: all 0.2s;
  }

  .checkout-btn:disabled {
    background-color: #d7d5ce;
    border-color: #d7d5ce;
    color: var(--color-white);
  }

  .checkout-btn:not(:disabled):hover {
    background-color: var(--color-primary-hover);
    border-color: var(--color-primary-hover);
  }

  /* Collapsible section styles */
  .cart-accordion {
    background-color: var(--color-bg-light);
    border-radius: 30px;
    margin-top: 0.75rem;
    overflow: hidden;
  }

  .cart-accordion summary {
    padding: 2rem;
    cursor: pointer;
    list-style: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .cart-accordion summary::-webkit-details-marker {
    display: none;
  }

  .cart-accordion summary::marker {
    display: none;
  }

  .cart-accordion-title {
    margin: 0;
  }

  .cart-accordion-icon {
    width: 24px;
    height: 24px;
    transition: transform 0.3s ease;
    flex-shrink: 0;
  }

  .cart-accordion[open] .cart-accordion-icon {
    transform: rotate(180deg);
  }

  .cart-accordion-content {
    padding: 0 2rem 2rem 2rem;
  }

  .cart-accordion-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: #646665;
  }

  .cart-accordion-status.complete {
    color: #22c55e;
  }

  .status-icon {
    width: 20px;
    height: 20px;
  }
</style>

<section class="bg-bg-extralight py-16" data-cart-section>
  <h1 class="font-titles font-bold text-4xl sm:text-5xl md:text-6xl lg:text-7xl 2xl:text-8xl text-center">Order Summary</h1>
  <div class="w-full px-4 mx-auto mt-8">
    <div class="max-w-[var(--width-container-content)] mx-auto">
      {% comment %} Fetch the Puppy Delivery Option product {% endcomment %}
      {% assign delivery_product = all_products['puppy-delivery-option'] %}

      {% comment %} Check if there's a puppy in the cart {% endcomment %}
      {% assign has_puppy = false %}
      {% for item in cart.items %}
        {% unless item.product.title contains 'Puppy Delivery Option' %}
          {% assign has_puppy = true %}
          {% break %}
        {% endunless %}
      {% endfor %}

      <form action="{{ routes.cart_url }}" method="post" novalidate class="cart-form">
        <div class="flex flex-wrap -mx-4">
          <div class="w-full lg:w-9/12 px-4">
            {% if cart.item_count == 0 %}
              <p class="text-lg">Your cart is empty.</p>
            {% else %}
              {% for item in cart.items %}
                {% unless item.product.title contains 'Puppy Delivery Option' %}
                  {% assign unit_price = item.final_line_price | divided_by: item.quantity %}

                  <!-- each cart item -->
                  
                  <!-- border radius, background color --color-bg-light,  -->
                  <a class="block bg-bg-light rounded-[30px] overflow-hidden" href="{{ item.url }}" data-line="{{ item.key }}">
                    <div class="flex">

                      <!-- border-right 5px --color-primary -->
                      <div class="w-1/4 bg-cover bg-no-repeat bg-center border-r-[5px] border-primary aspect-square" style="background-image:url({{ item.image | image_url: width: 360 }})">
                      </div>
                      <div class="w-3/4 p-4 md:p-6 flex flex-col justify-between">
                        <div>
                          <h3 class="text-3xl md:text-4xl lg:text-5xl font-semibold leading-tight tracking-tight mb-1">{{- item.product.title -}}</h3>
                          
                          <div class="text-xl md:text-2xl font-medium text-[#646665] mb-3">
                            {{ item.product.collections.first.title }}
                          </div>

                          {% comment %} Calculate age in weeks {% endcomment %}
                          {% assign dob_val = item.product.metafields.custom.dob.value %}
                          {% assign dob_ts = dob_val | date: '%s' | plus: 0 %}
                          {% assign now_ts = 'now' | date: '%s' | plus: 0 %}
                          {% assign diff_seconds = now_ts | minus: dob_ts %}
                          {% assign weeks_old = diff_seconds | divided_by: 604800 %}

                          {% comment %} Details grid {% endcomment %}
                          <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-base md:text-lg mb-3">
                            {% if item.product.metafields.custom.sex %}
                              <div class="text-[#646665]">
                                <span class="font-medium text-body-copy">Sex:</span> {{ item.product.metafields.custom.sex }}
                              </div>
                            {% endif %}
                            
                            {% if item.product.metafields.custom.color %}
                              <div class="text-[#646665]">
                                <span class="font-medium text-body-copy">Color:</span> {{ item.product.metafields.custom.color }}
                              </div>
                            {% endif %}
                            
                            {% if weeks_old %}
                              <div class="text-[#646665]">
                                <span class="font-medium text-body-copy">Age:</span> {{ weeks_old | floor }} weeks
                              </div>
                            {% endif %}

                            {% if item.product.metafields.custom.size %}
                              <div class="text-[#646665]">
                                <span class="font-medium text-body-copy">Size:</span> {{ item.product.metafields.custom.size }}
                              </div>
                            {% endif %}

                            {% if item.product.metafields.custom.variety %}
                              <div class="text-[#646665]">
                                <span class="font-medium text-body-copy">Variety:</span> {{ item.product.metafields.custom.variety }}
                              </div>
                            {% endif %}

                            {% if item.product.metafields.custom.generation %}
                              <div class="text-[#646665]">
                                <span class="font-medium text-body-copy">Generation:</span> {{ item.product.metafields.custom.generation }}
                              </div>
                            {% endif %}
                          </div>

                          {% comment %} Registration badge if available {% endcomment %}
                          {% if item.product.metafields.custom.registry %}
                            <div class="mb-3">
                              <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium bg-primary/10 text-primary">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                  <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                                </svg>
                                {{ item.product.metafields.custom.registry }} Registered
                              </span>
                            </div>
                          {% endif %}
                        </div>

                        {% comment %} Price at bottom {% endcomment %}
                        <div class="flex items-center justify-between mt-2">
                          <span class="text-2xl md:text-3xl font-bold text-primary">{{ item.final_line_price | money }}</span>
                          <span class="text-sm text-[#646665] hover:text-red-500 transition-colors" onclick="event.preventDefault(); if(confirm('Remove this puppy from your cart?')) { window.location.href='/cart/change?id={{ item.key }}&quantity=0'; }">
                            Remove
                          </span>
                        </div>
                      </div>
                    </div>
                  </a>

                {% endunless %}
              {% endfor %}
            {% endif %}


            <!-- Delivery Options section -->
            {% comment %} Only show delivery options if there's a puppy in the cart {% endcomment %}
            {% if has_puppy and delivery_product %}
              <details class="cart-accordion" id="delivery-accordion">
                <summary>
                  <div>
                    <h2 class="cart-accordion-title font-titles font-bold text-4xl md:text-5xl lg:text-6xl text-[#646665]">
                      Choose Delivery Option
                    </h2>
                    <div class="cart-accordion-status mt-2" id="delivery-status">
                      <span>Not selected</span>
                    </div>
                  </div>
                  <svg class="cart-accordion-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                </summary>
                <div class="cart-accordion-content">
                  {% comment %} Hidden container for variant descriptions {% endcomment %}
                  <div id="variant-descriptions" style="display: none;">
                    {{ delivery_product.description }}
                  </div>

                  <div id="delivery-options" class="space-y-3">
                  {% for variant in delivery_product.variants %}
                    {% comment %} Map variant title to description div ID {% endcomment %}
                    {% assign description_id = '' %}
                    {% if variant.title contains 'Home' or variant.title contains 'Your Home' %}
                      {% assign description_id = 'home-delivery' %}
                    {% elsif variant.title contains 'Nearby' or variant.title contains 'Near' %}
                      {% assign description_id = 'near-home' %}
                    {% elsif variant.title contains 'Pick Up' or variant.title contains 'Breeder' %}
                      {% assign description_id = 'local-pickup' %}
                    {% elsif variant.title contains 'Later' or variant.title contains 'Decide' %}
                      {% assign description_id = 'decide-later' %}
                    {% endif %}

                    <div class="checkout-agreement p-8">
                      <div class="flex items-start gap-4">
                        <input
                          type="radio"
                          name="delivery"
                          value="{{ variant.id }}"
                          class="mt-1"
                          data-description-id="{{ description_id }}"
                        >
                        <div class="flex-1">
                          <label class="text-lg font-medium cursor-pointer select-none block">
                            {{ variant.title }}
                            {% if variant.price > 0 %}
                              ({{ variant.price | money }})
                            {% else %}
                              (Free)
                            {% endif %}
                          </label>
                          {% if description_id != '' %}
                            <div
                              class="variant-description text-sm text-[#646665] mt-2"
                              data-for="{{ description_id }}"
                            ></div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                  </div>
                </div>
              </details>

              <script>
                // Move descriptions from hidden container to variant options
                document.addEventListener('DOMContentLoaded', () => {
                  const descriptionsContainer = document.getElementById('variant-descriptions');
                  if (!descriptionsContainer) return;

                  document.querySelectorAll('.variant-description').forEach((targetDiv) => {
                    const descId = targetDiv.getAttribute('data-for');
                    const sourceDiv = descriptionsContainer.querySelector(`#${descId}`);

                    if (sourceDiv) {
                      targetDiv.innerHTML = sourceDiv.innerHTML;
                    }
                  });
                });
              </script>
            {% endif %}


            <!-- Required Agreements section -->
            <details class="cart-accordion" id="agreements-accordion">
              <summary>
                <div>
                  <h2 class="cart-accordion-title font-titles font-bold text-4xl md:text-5xl lg:text-6xl text-body-copy">
                    Required Agreements
                  </h2>
                  <div class="cart-accordion-status mt-2" id="agreements-status">
                    <span>0 of 5 completed</span>
                  </div>
                </div>
                <svg class="cart-accordion-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </summary>
              <div class="cart-accordion-content">
              {% if cart.item_count > 0 %}
                <div class="space-y-3" data-terms>
                  <div class="checkout-agreement p-8">
                    <div class="flex items-start gap-4">
                      <input class="form-check-input mt-1" type="checkbox" id="certifyAge">
                      <div class="flex-1">
                        <label class="text-lg font-medium cursor-pointer select-none block" for="certifyAge">
                          Health Guarantee Agreement
                        </label>
                        <div class="mt-1">
                          I have read and agree to the Puppys R Us
                          <a
                            href="https://puppysrusdev.myshopify.com/pages/health-guarantee"
                            class="text-primary no-underline hover:underline"
                            >Health Guarantee</a
                          >.
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="checkout-agreement p-8">
                    <div class="flex items-start gap-4">
                      <input class="form-check-input mt-1" type="checkbox" id="understandTerms">
                      <div class="flex-1">
                        <label class="text-lg font-medium cursor-pointer select-none block" for="understandTerms">
                          Terms & Conditions / Purchase Agreement
                        </label>
                        <div class="text-sm mt-1">
                          I confirm I am 18+ and agree to the Puppys R Us
                          <a
                            href="https://puppysrusdev.myshopify.com/pages/terms-of-service"
                            class="text-primary no-underline hover:underline"
                            >Terms & Conditions</a
                          >.
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="checkout-agreement p-8">
                    <div class="flex items-start gap-4">
                      <input class="form-check-input mt-1" type="checkbox" id="acknowledgeAgreement">
                      <div class="flex-1">
                        <label class="text-lg font-medium cursor-pointer select-none block" for="acknowledgeAgreement">
                          Veterinary Care Acknowledgment
                        </label>
                        <div class="text-sm mt-1">
                          I understand I must take my puppy to a licensed veterinarian within 72 hours of receiving
                          him/her.
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="checkout-agreement p-8">
                    <div class="flex items-start gap-4">
                      <input class="form-check-input mt-1" type="checkbox" id="acknowledgeAgreement1">
                      <div class="flex-1">
                        <label class="text-lg font-medium cursor-pointer select-none block" for="acknowledgeAgreement1">
                          Transportation Agreement
                        </label>
                        <div class="text-sm mt-1">
                          I understand my puppy will travel by safe, approved methods arranged by Puppys R Us, and I
                          will be contacted to confirm details.
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="checkout-agreement p-8">
                    <div class="flex items-start gap-4">
                      <input class="form-check-input mt-1" type="checkbox" id="acknowledgeAgreement2">
                      <div class="flex-1">
                        <label class="text-lg font-medium cursor-pointer select-none block" for="acknowledgeAgreement2">
                          Puppy Confirmation
                        </label>
                        <div class="text-sm mt-1">I confirm I am purchasing the puppy listed in my order summary.</div>
                      </div>
                    </div>
                  </div>
                </div>
              {% endif %}
              </div>
            </details>
          </div>

          <div class="w-full lg:w-3/12 px-4">
            <div class="order-summary-box p-4">
              <h4 class="font-titles font-bold text-4xl md:text-5xl lg:text-6xl text-[#646665] mb-4">Total</h4>
              <ul class="list-none m-0 p-0 mb-4">
                <li class="flex justify-between items-center py-2">
                  <strong class="text-[#646665]">Puppy Price</strong>
                  <span>{{ cart.items_subtotal_price | money }}</span>
                </li>

                {% if shop.taxes_included %}
                  <li class="text-sm italic border-b-0">Tax included. Shipping calculated at checkout.</li>
                {% else %}
                  <li class="text-sm italic border-b-0">Taxes and shipping calculated at checkout.</li>
                {% endif %}

                <li class="flex justify-between items-center py-2 border-b-0 text-2xl">
                  <strong class="text-[#646665] font-titles">Total</strong>
                  <span>{{ cart.items_subtotal_price | money }}</span>
                </li>
              </ul>

              {% if cart.item_count > 0 %}
                <input
                  id="checkoutBtn"
                  type="submit"
                  name="checkout"
                  class="checkout-btn w-full py-3 px-9 text-white border-2 cursor-pointer mb-3 bg-[var(--color-primary)] border-[var(--color-primary)]"
                  disabled
                  aria-disabled="true"
                  value="{{ 'cart.checkout' | t }}"
                >
                <div
                  id="checkout-text1"
                  class="text-center text-sm py-2 px-4 bg-white rounded-lg text-[var(--color-primary)] mb-4"
                >
                  Please accept all terms and select a shipping method
                </div>
              {% endif %}
            </div>
            <img
              class="w-full mt-5 ml-5"
              src="{{ 'puppies Images.png' | asset_url }}"
              alt="Payment methods"
              width="300"
              height="100"
            >
          </div>
        </div>
      </form>
    </div>
  </div>
</section>

<script>
  // Auto-check the correct radio on page load
  document.addEventListener('DOMContentLoaded', async () => {
    const radios = document.querySelectorAll('input[name="delivery"]');

    const cart = await fetch('/cart.js').then((res) => res.json());

    const deliveryItem = cart.items.find((item) => item.product_title === 'Puppy Delivery Option');

    if (deliveryItem) {
      const selectedId = deliveryItem.variant_id;

      radios.forEach((radio) => {
        radio.checked = Number(radio.value) === selectedId;
      });
    }
  });

  // Add / remove delivery options on change
  document.querySelectorAll('input[name="delivery"]').forEach((radio) => {
    radio.addEventListener('change', async (e) => {
      const selectedVariant = Number(e.target.value);

      // Fetch current cart
      const cart = await fetch('/cart.js').then((res) => res.json());

      // Remove ALL delivery variants
      const deliveryItems = cart.items.filter((item) => item.product_title === 'Puppy Delivery Option');

      for (const item of deliveryItems) {
        await fetch('/cart/change.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: item.key,
            quantity: 0,
          }),
        });
      }

      // Add selected variant
      await fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          id: selectedVariant,
          quantity: 1,
        }),
      });

      // Refresh
      location.reload();
    });
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Quantity +/- and auto-submit
    const form = document.querySelector('.cart-form');
    const debouncedSubmit = (() => {
      let t;
      return () => {
        clearTimeout(t);
        t = setTimeout(() => form.requestSubmit(), 350);
      };
    })();

    document.querySelectorAll('.cart-quantity').forEach((wrap) => {
      const minus = wrap.querySelector('.btn-minus');
      const plus = wrap.querySelector('.btn-plus');
      const input = wrap.querySelector('.qty-input');

      plus.addEventListener('click', () => {
        const v = parseInt(input.value || '0', 10) + 1;
        input.value = Math.max(0, v);
        debouncedSubmit();
      });

      minus.addEventListener('click', () => {
        const v = parseInt(input.value || '0', 10) - 1;
        input.value = Math.max(0, v);
        debouncedSubmit();
      });

      input.addEventListener('input', () => {
        const cleansed = input.value.replace(/\D+/g, '');
        input.value = cleansed === '' ? '0' : cleansed;
        debouncedSubmit();
      });
    });

    // Gate checkout until all checkboxes are ticked and delivery method selected (if applicable)
    const checks = [
      document.getElementById('certifyAge'),
      document.getElementById('understandTerms'),
      document.getElementById('acknowledgeAgreement'),
      document.getElementById('acknowledgeAgreement1'),
      document.getElementById('acknowledgeAgreement2'),
    ].filter(Boolean);

    const checkoutBtn = document.getElementById('checkoutBtn');
    const deliveryOptions = document.querySelectorAll('input[name="delivery"]');

    function syncCheckoutState() {
      const allCheckboxesChecked = checks.length === 0 || checks.every((cb) => cb.checked);

      // Check if delivery option is selected (only if delivery options exist)
      const deliverySelected =
        deliveryOptions.length === 0 || Array.from(deliveryOptions).some((radio) => radio.checked);

      if (allCheckboxesChecked && deliverySelected) {
        checkoutBtn?.classList.remove('is-disabled');
        checkoutBtn?.removeAttribute('disabled');
        checkoutBtn?.setAttribute('aria-disabled', 'false');
        document.getElementById('checkout-text1').style.display = 'none';
      } else {
        checkoutBtn?.classList.add('is-disabled');
        checkoutBtn?.setAttribute('disabled', 'disabled');
        checkoutBtn?.setAttribute('aria-disabled', 'true');
        document.getElementById('checkout-text1').style.display = 'inline-block';
      }
    }

    checks.forEach((cb) => cb.addEventListener('change', syncCheckoutState));
    deliveryOptions.forEach((radio) => radio.addEventListener('change', syncCheckoutState));
    syncCheckoutState();

    // Update accordion status indicators
    function updateDeliveryStatus() {
      const deliveryStatus = document.getElementById('delivery-status');
      if (!deliveryStatus) return;
      
      const selectedRadio = document.querySelector('input[name="delivery"]:checked');
      if (selectedRadio) {
        const label = selectedRadio.closest('.checkout-agreement').querySelector('label');
        const selectedText = label ? label.textContent.trim().split('(')[0].trim() : 'Selected';
        deliveryStatus.innerHTML = `
          <svg class="status-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          <span>${selectedText}</span>
        `;
        deliveryStatus.classList.add('complete');
      } else {
        deliveryStatus.innerHTML = '<span>Not selected</span>';
        deliveryStatus.classList.remove('complete');
      }
    }

    function updateAgreementsStatus() {
      const agreementsStatus = document.getElementById('agreements-status');
      if (!agreementsStatus) return;
      
      const checkedCount = checks.filter(cb => cb.checked).length;
      const totalCount = checks.length;
      
      if (checkedCount === totalCount) {
        agreementsStatus.innerHTML = `
          <svg class="status-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          <span>All agreements accepted</span>
        `;
        agreementsStatus.classList.add('complete');
      } else {
        agreementsStatus.innerHTML = `<span>${checkedCount} of ${totalCount} completed</span>`;
        agreementsStatus.classList.remove('complete');
      }
    }

    // Add listeners for status updates
    checks.forEach((cb) => cb.addEventListener('change', updateAgreementsStatus));
    deliveryOptions.forEach((radio) => radio.addEventListener('change', updateDeliveryStatus));
    
    // Initial status update
    updateDeliveryStatus();
    updateAgreementsStatus();
  });
</script>

{% schema %}
{
  "name": "t:general.cart",
  "settings": []
}
{% endschema %}
